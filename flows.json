[{"id":"bf015507.7bce28","type":"tab","label":"Run on 1st Start ","disabled":false,"info":""},{"id":"6b2035a9.ca9f5c","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"568270ff.ffeb2","type":"tls-config","z":"","name":"","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"","servername":"api.ipify.org","verifyservercert":false},{"id":"4cafb41e.aec7fc","type":"tls-config","z":"","name":"","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"","servername":"api.ipify.org","verifyservercert":false},{"id":"72c2668c.2d7598","type":"mqtt-broker","z":"","name":"","broker":"demo-na.mqtttest.com","port":"8883","tls":"297e6fb8.d69b2","clientid":"$(CLIENTID)","usetls":true,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"demo/MAAPx/clientstate/connect","birthQos":"0","birthRetain":"false","birthPayload":"$(CLIENTID)","closeTopic":"demo/MAAPx/clientstate/close","closeQos":"0","closeRetain":"false","closePayload":"$(CLIENTID)","willTopic":"demo/MAAPx/clientstate/lastwill","willQos":"0","willRetain":"false","willPayload":"$(CLIENTID)"},{"id":"297e6fb8.d69b2","type":"tls-config","z":"","name":"demo-na.mqtttest.com","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"","servername":"demo-na.mqtttest.com","verifyservercert":true},{"id":"527d9d0d.66b1b4","type":"tls-config","z":"","name":"","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"","servername":"","verifyservercert":true},{"id":"2d748829.2503d8","type":"tls-config","z":"","name":"demo-na.mqtttest.com","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"","servername":"demo-na.mqtttest.com","verifyservercert":true},{"id":"3c9fafa.7dd6a5","type":"mqtt-broker","z":"","name":"","broker":"demo-na.mqtttest.com","port":"8883","tls":"2d748829.2503d8","clientid":"$(CLIENTID)","usetls":true,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"demo/MAAPx/clientstate/connect","birthQos":"0","birthRetain":"false","birthPayload":"$(CLIENTID)","closeTopic":"demo/MAAPx/clientstate/close","closeQos":"0","closeRetain":"false","closePayload":"$(CLIENTID)","willTopic":"demo/MAAPx/clientstate/lastwill","willQos":"0","willRetain":"false","willPayload":"$(CLIENTID)"},{"id":"861c5551.bc4558","type":"tls-config","z":"","name":"","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"","servername":"api.ipify.org","verifyservercert":false},{"id":"516d9faa.1f77f","type":"mqtt-broker","z":"","name":"","broker":"test.mosquitto.org","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"1a9ac59c.bc2eca","type":"mqtt-broker","z":"","name":"","broker":"clientcert.mqtttest.com","port":"8883","tls":"ac4297.b5ce6d68","clientid":"66","usetls":true,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"ac4297.b5ce6d68","type":"tls-config","z":"","name":"clientcert.mqtttest.com","cert":"","key":"","ca":"","certname":"testclient.pem","keyname":"testclient.key","caname":"ca2.pem","servername":"clientcert.mqtttest.com","verifyservercert":true},{"id":"32bcde51.e1eba2","type":"tls-config","z":"","name":"","cert":"","key":"","ca":"","certname":"sa-bench.cert.pem","keyname":"sa-bench.private.key","caname":"AmazonRootCA1.pem.txt","servername":"a2eb5sioxohndh-ats.iot.us-east-2.amazonaws.com","verifyservercert":true},{"id":"d04f47c4.ef34b8","type":"mqtt-broker","z":"","name":"","broker":"a2eb5sioxohndh-ats.iot.us-east-2.amazonaws.com","port":"8883","tls":"32bcde51.e1eba2","clientid":"sdk-nodejs-87a1ddac-59c9-493d-9b3f-a44663decce3","usetls":true,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"28773a0f.188736","type":"inject","z":"bf015507.7bce28","name":"generate timestamp for client ID","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":650,"y":100,"wires":[["ab6a9083.d16ea"]]},{"id":"e9231543.4ab608","type":"template","z":"bf015507.7bce28","name":"Form URL request for JWT","field":"url","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"https://iec-node-red.go.akamai-access.com/signing?clientID={{clientid}}","output":"str","x":640,"y":380,"wires":[["1f774772.528a89"]]},{"id":"446d8e75.4f16e","type":"file in","z":"bf015507.7bce28","name":"Read node-red settings file ","filename":"/data/settings.js","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":640,"y":500,"wires":[["6ae6d973.adca58"]]},{"id":"6ae6d973.adca58","type":"change","z":"bf015507.7bce28","name":"Replace default MQTT Client ID and JWT","rules":[{"t":"change","p":"payload","pt":"msg","from":"putclientidhere","fromt":"str","to":"clientid","tot":"msg"},{"t":"change","p":"payload","pt":"msg","from":"putjwthere","fromt":"str","to":"jwt","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":680,"y":540,"wires":[["7d98d982.a97a08"]]},{"id":"d66dd7f1.f6c178","type":"change","z":"bf015507.7bce28","name":"Set msg.clientid  property","rules":[{"t":"set","p":"clientid","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":630,"y":180,"wires":[["55f5a017.23ae2"]]},{"id":"7d98d982.a97a08","type":"file","z":"bf015507.7bce28","name":"Overwrite settings.js file with new client ID and JWT","filename":"/data/settings.js","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":710,"y":580,"wires":[["c14136e.e5e46c8"]]},{"id":"f7feefb4.b5b71","type":"change","z":"bf015507.7bce28","name":"Set msg.jwt property","rules":[{"t":"set","p":"jwt","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":620,"y":460,"wires":[["446d8e75.4f16e"]]},{"id":"1f774772.528a89","type":"http request","z":"bf015507.7bce28","name":"make HTTP request for JWT","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":640,"y":420,"wires":[["f7feefb4.b5b71"]]},{"id":"f5a3ce3a.5e81a","type":"comment","z":"bf015507.7bce28","name":"Run on Startup ","info":"","x":300,"y":20,"wires":[]},{"id":"ab6a9083.d16ea","type":"switch","z":"bf015507.7bce28","name":"Check for ClientID Presence ","property":"CLIENTID","propertyType":"env","rules":[{"t":"neq","v":"putclientidhere","vt":"str"},{"t":"eq","v":"putclientidhere","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":640,"y":140,"wires":[[],["d66dd7f1.f6c178"]]},{"id":"55f5a017.23ae2","type":"http request","z":"bf015507.7bce28","name":"Lookup IP Address of Client","method":"GET","ret":"txt","paytoqs":false,"url":"https://api.ipify.org?format=json","tls":"861c5551.bc4558","persist":false,"proxy":"","authType":"","x":640,"y":220,"wires":[["5cd63545.361edc"]]},{"id":"5cd63545.361edc","type":"json","z":"bf015507.7bce28","name":"convert to JSON","property":"payload","action":"","pretty":false,"x":610,"y":260,"wires":[["80988913.f598f8"]]},{"id":"80988913.f598f8","type":"template","z":"bf015507.7bce28","name":"Form URL for Node-Red","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"[[\"http://{{payload.ip}}:1880\",\"{{clientid}}\"]]","output":"str","x":630,"y":300,"wires":[["1b28919c.cb652e","441fe93.50b7518"]]},{"id":"1b28919c.cb652e","type":"debug","z":"bf015507.7bce28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1060,"y":340,"wires":[]},{"id":"441fe93.50b7518","type":"json","z":"bf015507.7bce28","name":"convert to JSON","property":"payload","action":"","pretty":false,"x":410,"y":340,"wires":[["e9231543.4ab608"]]},{"id":"f26ca21.902e66","type":"inject","z":"6b2035a9.ca9f5c","name":"Inject every second","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":true,"onceDelay":0.1,"x":160,"y":200,"wires":[["fab80017.7942b"]]},{"id":"6267bed2.9eb7e","type":"function","z":"6b2035a9.ca9f5c","name":"Add current epoch timestamp ","func":"msg.payload.time = Date.now() \nreturn msg;","outputs":1,"noerr":0,"x":190,"y":280,"wires":[["57e94275.f8172c"]]},{"id":"57e94275.f8172c","type":"mqtt out","z":"6b2035a9.ca9f5c","name":"publish to EdgeConnect","topic":"demo/latency/sa/publish","qos":"","retain":"","broker":"3c9fafa.7dd6a5","x":170,"y":320,"wires":[]},{"id":"648fdca2.9de5c4","type":"mqtt in","z":"6b2035a9.ca9f5c","name":"Listen for Publish Messages","topic":"demo/latency/sa/publish","qos":"2","datatype":"json","broker":"3c9fafa.7dd6a5","x":180,"y":440,"wires":[["958e594e.3c2e08"]]},{"id":"958e594e.3c2e08","type":"function","z":"6b2035a9.ca9f5c","name":"Calculate Time Difference ","func":"var now = Date.now();\nvar then = msg.payload.time;\nmsg.payload.latency = now - then;\nreturn msg","outputs":1,"noerr":0,"x":170,"y":520,"wires":[["4054b25f.85648c"]]},{"id":"fab80017.7942b","type":"template","z":"6b2035a9.ca9f5c","name":"Extract Geo and Org info from global variables","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\"publishregion\":\"{{global.regionName}}\",\"publishcountry\":\"{{global.countryCode}}\",\"publishorg\":\"{{global.org}}\"}","output":"json","x":240,"y":240,"wires":[["6267bed2.9eb7e"]]},{"id":"4054b25f.85648c","type":"change","z":"6b2035a9.ca9f5c","name":"Extract Geo Location from Global Variables","rules":[{"t":"set","p":"payload.regionName","pt":"msg","to":"regionName","tot":"global"},{"t":"set","p":"payload.countryCode","pt":"msg","to":"countryCode","tot":"global"},{"t":"set","p":"payload.org","pt":"msg","to":"org","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":230,"y":560,"wires":[["e270e69d.557118","676b2da5.b9cad4"]]},{"id":"c14136e.e5e46c8","type":"http request","z":"bf015507.7bce28","name":"Lookup public IP address","method":"GET","ret":"txt","paytoqs":false,"url":"wgetip.com","tls":"","persist":false,"proxy":"","authType":"","x":630,"y":620,"wires":[["8d12a183.173a8"]]},{"id":"8d12a183.173a8","type":"template","z":"bf015507.7bce28","name":"Format GeoIP Lookup","field":"url","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"http://ip-api.com/json/{{payload}}","output":"str","x":620,"y":660,"wires":[["3be62f76.85d44"]]},{"id":"3be62f76.85d44","type":"http request","z":"bf015507.7bce28","name":"GeoIP Lookup","method":"GET","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":600,"y":700,"wires":[["2abb8b39.7401e4"]]},{"id":"2abb8b39.7401e4","type":"json","z":"bf015507.7bce28","name":"Convert GeoIP Response to json ","property":"payload","action":"","pretty":false,"x":660,"y":740,"wires":[["70115076.ef819"]]},{"id":"32556446.df3bec","type":"template","z":"bf015507.7bce28","name":"Format iplocation file","field":"payload","fieldType":"msg","format":"json","syntax":"mustache","template":"{\"regionName\":\"{{payload.regionName}}\",\"countryCode\":\"{{payload.countryCode}}\",\"org\":\"{{payload.org}}\"}","output":"str","x":620,"y":820,"wires":[["796bd8c3.910ba8"]]},{"id":"796bd8c3.910ba8","type":"file","z":"bf015507.7bce28","name":"write iplocation file to disk ","filename":"/data/iplocation","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":630,"y":860,"wires":[[]]},{"id":"70115076.ef819","type":"change","z":"bf015507.7bce28","name":"Set Global Variables ","rules":[{"t":"set","p":"regionName","pt":"global","to":"payload.regionName","tot":"msg"},{"t":"set","p":"countryCode","pt":"global","to":"payload.countryCode","tot":"msg"},{"t":"set","p":"org","pt":"global","to":"payload.org","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":620,"y":780,"wires":[["32556446.df3bec"]]},{"id":"dcfa11ab.24416","type":"comment","z":"6b2035a9.ca9f5c","name":"Publisher","info":"","x":130,"y":160,"wires":[]},{"id":"e270e69d.557118","type":"mqtt out","z":"6b2035a9.ca9f5c","name":"publish results to Edge Connect","topic":"demo/latency/sa/results","qos":"","retain":"","broker":"3c9fafa.7dd6a5","x":190,"y":600,"wires":[]},{"id":"578b0ad2.ac3a24","type":"comment","z":"6b2035a9.ca9f5c","name":"Subscriber","info":"","x":130,"y":400,"wires":[]},{"id":"676b2da5.b9cad4","type":"debug","z":"6b2035a9.ca9f5c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":580,"y":560,"wires":[]},{"id":"437f171b.5b09a8","type":"inject","z":"6b2035a9.ca9f5c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":530,"y":160,"wires":[["3b5af446.45cf7c"]]},{"id":"3b5af446.45cf7c","type":"file in","z":"6b2035a9.ca9f5c","name":"","filename":"/data/iplocation","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":630,"y":220,"wires":[["f065e9cd.314428"]]},{"id":"f065e9cd.314428","type":"json","z":"6b2035a9.ca9f5c","name":"","property":"payload","action":"","pretty":false,"x":620,"y":300,"wires":[["a917107c.9fbfd"]]},{"id":"ee688f49.2d2ab","type":"debug","z":"6b2035a9.ca9f5c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":690,"y":420,"wires":[]},{"id":"a917107c.9fbfd","type":"change","z":"6b2035a9.ca9f5c","name":"","rules":[{"t":"set","p":"regionName","pt":"global","to":"payload.regionName","tot":"msg"},{"t":"set","p":"org","pt":"global","to":"payload.org","tot":"msg"},{"t":"set","p":"countryCode","pt":"global","to":"payload.countryCode","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":660,"y":360,"wires":[["ee688f49.2d2ab"]]},{"id":"d6d75317.def4a","type":"http in","z":"bf015507.7bce28","name":"","url":"/hello","method":"get","upload":false,"swaggerDoc":"","x":100,"y":100,"wires":[["2dc5afa0.873f6"]]},{"id":"34c80f02.367f","type":"http response","z":"bf015507.7bce28","name":"","statusCode":"","headers":{},"x":440,"y":100,"wires":[]},{"id":"2dc5afa0.873f6","type":"change","z":"bf015507.7bce28","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"text\":\"Hello\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":100,"wires":[["34c80f02.367f"]]}]